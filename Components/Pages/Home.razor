@page "/"
@inject NavigationManager NavManager
@rendermode InteractiveServer
@using GooruuSearchApp.Services
@inject MockSearchService SearchService
<PageTitle>Gooruu</PageTitle>

<div class="search-container">
    <div class="gooruu-logo">
        <span class="g-blue">G</span><span class="g-red">o</span><span class="g-yellow">o</span><span class="g-blue">r</span><span class="g-green">u</span><span class="g-red">u</span>
    </div>

    <div class="search-input-wrapper" style="position:relative;">
        <span class="material-icons" style="position:absolute; left:15px; top:12px; color:#9aa0a6;">search</span>

        <input type="text"
               class="search-input"
               placeholder="ค้นหาใน Gooruu หรือ พิมพ์ URL"
               value="@searchQuery"
               @oninput="HandleInput"
               @onfocusout="HandleBlur"
               @onkeyup="HandleEnter" />

        @if (showSuggestions && suggestions.Any())
        {
            <div class="autocomplete-dropdown">
                @foreach (var item in suggestions)
                {
                    <div class="autocomplete-item" @onmousedown="() => SelectSuggestion(item)">
                        <span class="material-icons autocomplete-icon">schedule</span> <span>@item</span>
                    </div>
                }
            </div>
        }
    </div>

    <div style="margin-top: 30px;">
        <button class="btn btn-light me-2" @onclick="DoSearch">ค้นหาด้วย Gooruu</button>
        <button class="btn btn-light" @onclick="DoLuckySearch">ดีใจจัง ค้นแล้วเจอเลย</button>
    </div>
</div>

@code {
    private string searchQuery = "";
    private List<string> suggestions = new();
    private bool showSuggestions = false;

    // เมื่อมีการพิมพ์ (ทำงานทันทีทีละตัวอักษร)
    private void HandleInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";

        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            suggestions = SearchService.GetSuggestions(searchQuery);
            showSuggestions = suggestions.Any();
        }
        else
        {
            showSuggestions = false;
        }
    }

    // เมื่อเลือกคำแนะนำจาก Dropdown
    private void SelectSuggestion(string value)
    {
        searchQuery = value;
        showSuggestions = false;
        DoSearch(); // เลือกปุ๊บ ค้นหาเลย
    }

    // เมื่อเมาส์หลุดจากช่องค้นหา (ซ่อน Dropdown)
    private async Task HandleBlur()
    {
        // ต้อง Delay นิดนึง ไม่งั้นมันจะซ่อนก่อนที่ Event Click จะทำงาน
        await Task.Delay(200);
        showSuggestions = false;
    }

    private void HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") DoSearch();
    }

    private void DoSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            NavManager.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private void DoLuckySearch()
    {
        var results = SearchService.Search(searchQuery);
        if (results.Any())
        {
            NavManager.NavigateTo($"/news/{results.First().Id}");
        }
        else
        {
            DoSearch();
        }
    }
}