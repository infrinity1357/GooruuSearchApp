@page "/"
@inject NavigationManager NavManager
@rendermode InteractiveServer
@using GooruuSearchApp.Services
@inject MockSearchService SearchService
@implements IDisposable

<PageTitle>Gooruu</PageTitle>

<div class="search-container">
    <div class="gooruu-logo">
        <span class="g-blue">G</span><span class="g-red">o</span><span class="g-yellow">o</span><span class="g-blue">r</span><span class="g-green">u</span><span class="g-red">u</span>
    </div>

    <div class="search-input-wrapper" style="position:relative;">
        <span class="material-icons" style="position:absolute; left:15px; top:12px; color:#9aa0a6;">search</span>

        <input type="text"
               class="search-input"
               placeholder="ค้นหาใน Gooruu หรือ พิมพ์ URL"
               @bind="searchQuery"
               @bind:event="oninput"
               @onkeyup="HandleKeyUp"
               @onfocusout="HandleBlur" />

        @if (showSuggestions && suggestions.Any())
        {
            <div class="autocomplete-dropdown">
                @for (int i = 0; i < suggestions.Count; i++)
                {
                    var index = i; // Local variable for closure
                    var item = suggestions[i];
                    var isActive = index == selectedIndex ? "active" : "";

                    <div class="autocomplete-item @isActive"
                         @onmousedown="() => SelectSuggestion(item)"
                         @onmouseover="() => selectedIndex = index">
                        <span class="material-icons autocomplete-icon">schedule</span>
                        <span>@item</span>
                    </div>
                }
            </div>
        }
    </div>

    <div style="margin-top: 30px;">
        <button class="btn btn-light me-2" @onclick="DoSearch">ค้นหาด้วย Gooruu</button>
        <button class="btn btn-light" @onclick="DoLuckySearch">ดีใจจัง ค้นแล้วเจอเลย</button>
    </div>
</div>

@code {
    private string searchQuery = "";
    private List<string> suggestions = new();
    private bool showSuggestions = false;

    // ตัวแปรสำหรับ Debounce และ Keyboard Nav
    private System.Timers.Timer? _debounceTimer;
    private int selectedIndex = -1;

    protected override void OnInitialized()
    {
        // ตั้งค่า Timer รอ 300ms
        _debounceTimer = new System.Timers.Timer(300);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += OnDebounceElapsed;
    }

    // จัดการ KeyUp เพื่อทำ Debounce และ Navigation
    private void HandleKeyUp(KeyboardEventArgs e)
    {
        // 1. Navigation (ไม่ส่ง request)
        if (e.Key == "ArrowDown")
        {
            if (selectedIndex < suggestions.Count - 1) selectedIndex++;
            return;
        }
        else if (e.Key == "ArrowUp")
        {
            if (selectedIndex > -1) selectedIndex--;
            return;
        }
        else if (e.Key == "Enter")
        {
            if (selectedIndex >= 0 && selectedIndex < suggestions.Count)
            {
                SelectSuggestion(suggestions[selectedIndex]);
            }
            else
            {
                DoSearch();
            }
            return;
        }
        else if (e.Key == "Escape")
        {
            showSuggestions = false;
            return;
        }

        // 2. Logic การค้นหา (Debounce)
        // Reset timer ทุกครั้งที่พิมพ์
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    // ทำงานเมื่อ user หยุดพิมพ์ครบ 300ms
    private async void OnDebounceElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            suggestions.Clear();
            showSuggestions = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // ค้นหาจริง
        var results = SearchService.GetSuggestions(searchQuery);

        await InvokeAsync(() =>
        {
            suggestions = results;
            showSuggestions = suggestions.Any();
            selectedIndex = -1; // Reset selection
            StateHasChanged(); // สั่ง Rerender UI
        });
    }

    private void SelectSuggestion(string value)
    {
        searchQuery = value;
        showSuggestions = false;
        DoSearch();
    }

    private async Task HandleBlur()
    {
        // Delay เล็กน้อยเพื่อให้ event click ทำงานทัน
        await Task.Delay(200);
        showSuggestions = false;
    }

    private void DoSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            NavManager.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private void DoLuckySearch()
    {
        var results = SearchService.Search(searchQuery);
        if (results.Any())
        {
            NavManager.NavigateTo($"/news/{results.First().Id}");
        }
        else
        {
            DoSearch();
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
<style>
    .autocomplete-item {
        cursor: pointer;
        padding: 10px;
        display: flex;
        align-items: center;
    }

        /* เพิ่มส่วนนี้ */
        .autocomplete-item.active,
        .autocomplete-item:hover {
            background-color: #f1f3f4; /* สีเทาอ่อนแบบ Google */
            color: #202124;
        }
</style>